#!/bin/bash

# –ü–æ—Ä–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
THRESHOLD=20

# Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
EMAIL="georgiynge2025@gmail.com"

# –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ç—á–µ—Ç–∞
REPORT=$(mktemp)

# –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è /
USAGE=$(df -P / | tail -1 | awk '{print $(NF-1)}' | tr -d '%')

# –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–µ –ø–æ—Ä–æ–≥–∞
if [ "$USAGE" -gt "$THRESHOLD" ]; then
    echo "‚ö†Ô∏è –î–∏—Å–∫ / –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${USAGE}%. –ü–æ—Ä–æ–≥: ${THRESHOLD}%" | tee -a "$REPORT"

    echo -e "\nüîç –¢–û–ü-10 —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –≤ /home /var /opt:" >> "$REPORT"
    du -xh /home /var /opt 2>/dev/null | sort -rh | head -n 10 >> "$REPORT"

    echo -e "\nüì¶ –¢–û–ü-10 —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ /home /var /opt:" >> "$REPORT"
    find /home /var /opt -type f -exec du -h {} + 2>/dev/null | sort -rh | head -n 10 >> "$REPORT"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —É—Ç–∏–ª–∏—Ç—ã mail –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞
    if command -v mail >/dev/null 2>&1; then
        mail -s "‚ö†Ô∏è –î–∏—Å–∫ / –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${USAGE}%" "$EMAIL" < "$REPORT"
    else
        echo "‚ùó –£—Ç–∏–ª–∏—Ç–∞ 'mail' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ—ë –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π." | tee -a "$REPORT"
    fi
else
    echo "‚úÖ –î–∏—Å–∫ / –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${USAGE}%. –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ." | tee -a "$REPORT"
fi

# –í—ã–≤–æ–¥ –æ—Ç—á–µ—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω
cat "$REPORT"

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm -f "$REPORT"

